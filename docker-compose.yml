version: '2'
services:
  rabbit:
     image: rabbitmq:3-management
     env_file:
       - rabbit.env
     ports:
      - "5672:5672"
      - "15672:15672"
     networks:
      - sdx-env
  pure-ftpd:
     image: stilliard/pure-ftpd
     volumes:
       - ./pure-ftp:/etc/pure-ftpd
       - ./pure-ftp-structure:/home/ftpusers/ons
     environment:
       - PUBLICHOST=pure-ftpd
     networks:
      - sdx-env
  mongodb:
     image: mongo:3
     networks:
      - sdx-env
     ports:
      - "27017:27017"
  sdx-collect:
     restart: always
     build: ./sdx-collect
     ports:
       - "8080:8080"
     volumes:
       - ./sdx-collect/logs:/usr/src/logs
     depends_on:
       - rabbit
     environment:
       - RECEIPT_HOST=http://sdx-mock-receipt:5000
     env_file:
       - rabbit.env
       - ftp.env
       - common.env
     networks:
      - sdx-env
  sdx-decrypt:
     build: ./sdx-decrypt
     volumes:
       - ./sdx-decrypt/logs:/app/logs
       - ./sdx-decrypt:/app
       - ./jwt-test-keys:/keys
     env_file:
       - common.env
     networks:
      sdx-env:
        aliases:
          - posie
  sdx-validate:
     build: ./sdx-validate
     ports:
      - "8082:5000"
     volumes:
       - ./sdx-validate/logs:/app/logs
       - ./sdx-validate:/app
     networks:
       - sdx-env
     env_file:
       - common.env
  sdx-store:
    build: ./sdx-store
    ports:
     - "8085:5000"
    volumes:
      - ./sdx-store/logs:/usr/src/logs
      - ./sdx-store:/app
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
    env_file:
      - common.env
    networks:
      - sdx-env
  sdx-transform-cs:
     build: ./sdx-transform-cs
     ports:
      - "8083:5000"
     volumes:
       - ./sdx-transform-cs/logs:/app/logs
       - ./sdx-transform-cs:/app
     env_file:
       - common.env
     networks:
       - sdx-env
  sdx-transform-testform:
     build: ./sdx-transform-testform
     ports:
      - "8087:5000"
     env_file:
       - common.env
     volumes:
       - ./sdx-transform-testform/logs:/app/logs
       - ./sdx-transform-testform:/app
     networks:
       - sdx-env
  sdx-downstream:
     build: ./sdx-downstream
     volumes:
       - ./sdx-downstream/logs:/app/logs
       - ./sdx-downstream/app:/app
     environment:
       - SDX_STORE_URL=http://sdx-store:5000
       - SDX_TRANSFORM_CS_URL=http://sdx-transform-cs:5000
     env_file:
       - rabbit.env
       - ftp.env
       - common.env
     networks:
       - sdx-env
  sdx-sequence:
    build: ./sdx-sequence
    ports:
     - "8086:5000"
    env_file:
     - common.env
    volumes:
      - ./sdx-sequence/logs:/usr/src/logs
      - ./sdx-sequence:/app
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
    networks:
      - sdx-env
  bdd:
     build: ./sdx-bdd
     ports:
       - "8081:5000"
     volumes:
        - ./sdx-bdd:/app
        - ./jwt-test-keys:/keys
     networks:
       - sdx-env
     env_file:
       - rabbit.env
       - ftp.env
       - common.env
  sdx-mock-receipt:
      build: ./sdx-mock-receipt
      ports:
        - "88:5000"
      env_file:
        - common.env
      networks:
        - sdx-env
  console:
     build: ./sdx-console
     depends_on:
       - rabbit
     ports:
       - "80:5000"
     volumes:
       - ./sdx-console:/app
       - ./jwt-test-keys:/keys
     env_file:
       - rabbit.env
       - ftp.env
       - common.env
     entrypoint: python3 server.py
     networks:
      - sdx-env
networks:
  sdx-env:
    driver: bridge

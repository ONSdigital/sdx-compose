version: '2'
services:
  rabbit:
    image: rabbitmq:3-management
    env_file:
      - env/rabbit.env
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - sdx-env
  pure-ftpd:
    image: stilliard/pure-ftpd
    volumes:
      - ./pure-ftp:/etc/pure-ftpd
      - ./pure-ftp-structure:/home/ftpusers/ons
    environment:
      - PUBLICHOST=pure-ftpd
    networks:
      - sdx-env
  sftp:
    image: atmoz/sftp
    volumes:
        - ./sftp:/tmp
        - ~/.ssh/id_rsa.pub:/home/testuser/.ssh/keys/id_rsa.pub:ro
        - ~/.ssh/id_rsa:/etc/ssh/ssh_host_rsa_key
        - ~/.ssh/id_rsa.pub:/etc/ssh/ssh_host_rsa_key.pub
    ports:
        - "2222:22"
    command: testuser::501::public
  db:
    image: postgres:9.6
    volumes:
      - ./postgres/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    env_file:
      - env/db.env
    ports:
      - "5433:5432"
    networks:
      - sdx-env
  sdx-collect:
    restart: always
    build: ${SDX_HOME}/sdx-collect
    depends_on:
      - rabbit
    env_file:
      - env/rabbit.env
      - env/ftp.env
      - env/common.env
      - env/private.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-collect"
  sdx-seft-consumer-service:
    restart: always
    build: ${SDX_HOME}/sdx-seft-consumer-service
    depends_on:
      - rabbit
    env_file:
      - env/rabbit.env
      - env/ftp.env
      - env/common.env
      - env/private.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-seft-consumer-service"
  sdx-decrypt:
    build: ${SDX_HOME}/sdx-decrypt
    volumes:
      - ${SDX_HOME}/sdx-decrypt:/app
    env_file:
      - env/common.env
    networks:
      sdx-env:
        aliases:
           - posie
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-decrypt"
  sdx-validate:
    build: ${SDX_HOME}/sdx-validate
    ports:
     - "8082:5000"
    volumes:
     - ${SDX_HOME}/sdx-validate:/app
    networks:
     - sdx-env
    env_file:
     - env/common.env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-validate"
  sdx-receipt-rrm:
    restart: always
    build: ${SDX_HOME}/sdx-receipt-rrm
    depends_on:
      - rabbit
    environment:
      - RECEIPT_HOST=http://sdx-mock-receipt:5000
    env_file:
      - env/rabbit.env
      - env/common.env
      - env/receipt.env
      - env/private.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-collect"
  sdx-store:
    build: ${SDX_HOME}/sdx-store
    ports:
      - "8085:5000"
    volumes:
      - ${SDX_HOME}/sdx-store:/app
    env_file:
      - env/common.env
      - env/db.env
    depends_on:
      - "db"
      - "rabbit"
    networks:
      - sdx-env
    # logging:
    #     driver: syslog
    #     options:
    #       syslog-address: "udp://127.0.0.1:5514"
    #       tag: "sdx-store"
  sdx-transform-cs:
    build: ${SDX_HOME}/sdx-transform-cs
    ports:
      - "8083:5000"
    volumes:
      - ${SDX_HOME}/sdx-transform-cs:/app
    env_file:
      - env/common.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-transform-cs"
  sdx-transform-cora:
    build: ${SDX_HOME}/sdx-transform-cora
    ports:
      - "8084:5000"
    volumes:
      - ${SDX_HOME}/sdx-transform-cora:/app
    env_file:
      - env/common.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-transform-cora"
  sdx-downstream:
    build: ${SDX_HOME}/sdx-downstream
    volumes:
      - ${SDX_HOME}/sdx-downstream/app:/app
    environment:
      - SDX_STORE_URL=http://sdx-store:5000
      - SDX_TRANSFORM_CS_URL=http://sdx-transform-cs:5000
    env_file:
      - env/rabbit.env
      - env/ftp.env
      - env/common.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-downstream"
  sdx-sequence:
    build: ${SDX_HOME}/sdx-sequence
    ports:
      - "8086:5000"
    env_file:
      - env/common.env
      - env/db.env
    volumes:
      - ${SDX_HOME}/sdx-sequence:/app
    networks:
      - sdx-env
    depends_on:
      - "db"
    # logging:
    #     driver: syslog
    #     options:
    #       syslog-address: "udp://127.0.0.1:5514"
    #       tag: "sdx-sequence"
  sdx-mock-receipt:
    build: ${SDX_HOME}/sdx-mock-receipt
    ports:
      - "8088:5000"
    volumes:
      - ${SDX_HOME}/sdx-mock-receipt:/app
    env_file:
      - env/common.env
      - env/receipt.env
    networks:
      - sdx-env
    logging:
      driver: syslog
      options:
        syslog-address: "udp://127.0.0.1:5514"
        tag: "sdx-mock-receipt"
  console:
    build: ${SDX_HOME}/sdx-console
    depends_on:
      - db
      - rabbit
    ports:
      - "80:5000"
    volumes:
      - ${SDX_HOME}/sdx-console:/app
      - ./jwt-test-keys:/keys
    environment:
      - ENABLE_EMPTY_FTP=1
    env_file:
      - env/rabbit.env
      - env/db.env
      - env/ftp.env
      - env/common.env
    networks:
      - sdx-env
    # logging:
    #   driver: syslog
    #   options:
    #     syslog-address: "udp://127.0.0.1:5514"
    #     tag: "sdx-console"
  sdx-rabbit-monitor:
    build: ${SDX_HOME}/sdx-rabbit-monitor
    depends_on:
      - rabbit
    ports:
      - "8089:5000"
    volumes:
      - ${SDX_HOME}/sdx-rabbit-monitor:/app
    env_file:
      - env/rabbit.env
    networks:
      - sdx-env
  sdx-gateway:
    build: ${SDX_HOME}/sdx-gateway
    depends_on:
      - rabbit
    ports:
      - "8090:5000"
    volumes:
      - ${SDX_HOME}/sdx-gateway:/app
    env_file:
      - env/common.env
      - env/rabbit.env
    networks:
      - sdx-env
networks:
  sdx-env:
    driver: bridge
